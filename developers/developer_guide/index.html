
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../admins/workbench_admin_guide/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.21">
    
    
      
        <title>Developer Guide - Open Front End</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.66ac8b77.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Nunito";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#developer-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Open Front End" class="md-header__button md-logo" aria-label="Open Front End" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 2c-1.11 0-2 .89-2 2v3c0 1.11.89 2 2 2h1v2H2v2h4v2H5c-1.11 0-2 .89-2 2v3c0 1.11.89 2 2 2h4c1.11 0 2-.89 2-2v-3c0-1.11-.89-2-2-2H8v-2h8v2h-1c-1.11 0-2 .89-2 2v3c0 1.11.89 2 2 2h4c1.11 0 2-.89 2-2v-3c0-1.11-.89-2-2-2h-1v-2h4v-2h-9V9h1c1.11 0 2-.89 2-2V4c0-1.11-.89-2-2-2h-4m0 2h4v3h-4V4M5 17h4v3H5v-3m10 0h4v3h-4v-3Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Open Front End
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Developer Guide
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Open Front End" class="md-nav__button md-logo" aria-label="Open Front End" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 2c-1.11 0-2 .89-2 2v3c0 1.11.89 2 2 2h1v2H2v2h4v2H5c-1.11 0-2 .89-2 2v3c0 1.11.89 2 2 2h4c1.11 0 2-.89 2-2v-3c0-1.11-.89-2-2-2H8v-2h8v2h-1c-1.11 0-2 .89-2 2v3c0 1.11.89 2 2 2h4c1.11 0 2-.89 2-2v-3c0-1.11-.89-2-2-2h-1v-2h4v-2h-9V9h1c1.11 0 2-.89 2-2V4c0-1.11-.89-2-2-2h-4m0 2h4v3h-4V4M5 17h4v3H5v-3m10 0h4v3h-4v-3Z"/></svg>

    </a>
    Open Front End
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Users
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Users
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../users/user_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../users/workbench_user_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Workbench User Guide
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Admins
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Admins
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../admins/admin_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Admin Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../admins/advanced_admin_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced Admin Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../admins/cluster_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cluster Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../admins/application_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Application Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../admins/workbench_admin_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Workbench Admin Guide
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Developers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Developers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Developer Guide
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Developer Guide
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture-design" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture design
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-the-system" class="md-nav__link">
    <span class="md-ellipsis">
      Deploy the system
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-the-service-machine" class="md-nav__link">
    <span class="md-ellipsis">
      Access the service machine
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#directory-structures-on-service-machine" class="md-nav__link">
    <span class="md-ellipsis">
      Directory structures on service machine
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-time-data" class="md-nav__link">
    <span class="md-ellipsis">
      Run-time data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Run-time data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#for-cloud-resources" class="md-nav__link">
    <span class="md-ellipsis">
      For cloud resources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#for-applications" class="md-nav__link">
    <span class="md-ellipsis">
      For applications
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#for-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      For jobs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django-development" class="md-nav__link">
    <span class="md-ellipsis">
      Django development
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Django development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#database-design" class="md-nav__link">
    <span class="md-ellipsis">
      Database Design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-layout" class="md-nav__link">
    <span class="md-ellipsis">
      Code Layout
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code Layout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#infrastructure-files" class="md-nav__link">
    <span class="md-ellipsis">
      Infrastructure Files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#website" class="md-nav__link">
    <span class="md-ellipsis">
      Website
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workbenches-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Workbenches Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Workbenches Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#infrastructure-files_1" class="md-nav__link">
    <span class="md-ellipsis">
      Infrastructure files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage-mount-points" class="md-nav__link">
    <span class="md-ellipsis">
      Storage mount points
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#startup-script" class="md-nav__link">
    <span class="md-ellipsis">
      Startup script
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture-design" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture design
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-the-system" class="md-nav__link">
    <span class="md-ellipsis">
      Deploy the system
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-the-service-machine" class="md-nav__link">
    <span class="md-ellipsis">
      Access the service machine
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#directory-structures-on-service-machine" class="md-nav__link">
    <span class="md-ellipsis">
      Directory structures on service machine
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-time-data" class="md-nav__link">
    <span class="md-ellipsis">
      Run-time data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Run-time data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#for-cloud-resources" class="md-nav__link">
    <span class="md-ellipsis">
      For cloud resources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#for-applications" class="md-nav__link">
    <span class="md-ellipsis">
      For applications
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#for-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      For jobs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#django-development" class="md-nav__link">
    <span class="md-ellipsis">
      Django development
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Django development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#database-design" class="md-nav__link">
    <span class="md-ellipsis">
      Database Design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-layout" class="md-nav__link">
    <span class="md-ellipsis">
      Code Layout
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code Layout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#infrastructure-files" class="md-nav__link">
    <span class="md-ellipsis">
      Infrastructure Files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#website" class="md-nav__link">
    <span class="md-ellipsis">
      Website
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workbenches-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Workbenches Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Workbenches Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#infrastructure-files_1" class="md-nav__link">
    <span class="md-ellipsis">
      Infrastructure files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage-mount-points" class="md-nav__link">
    <span class="md-ellipsis">
      Storage mount points
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#startup-script" class="md-nav__link">
    <span class="md-ellipsis">
      Startup script
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="developer-guide">Developer Guide</h1>
<h2 id="architecture-design">Architecture design</h2>
<p>The HPC Toolkit FrontEnd is a web application integrating several front-end and
back-end technologies. <em>Django</em>, a high-level Python-based web framework, forms
the foundation of the web application. The back-end business logics can mostly
be delegated to <em>Terraform</em> to create GCP cloud infrastructure required by the
HPC clusters. With HPC Toolkit, there is no need to define infrastructure
configurations from scratch. Rather, a high-level description of the clusters
are provided for it to generate Terraform configurations.</p>
<p>The overall system design is described in the following figure:</p>
<p><img alt="System Design" src="../../images/system-design.png" /> <!--TODO: refine this sketch--></p>
<p>In most cases, end-users are expected to use and communicate with the cloud
systems via the FrontEnd. Of course, users from a traditional supercomputing
background may wish to work with HPC clusters from the command line. This is
entirely possible through the Slurm login nodes.</p>
<!--
In a production environment, it is typically good practice to leave the web
application behind a load balancer, which provides additional performance,
calability, and security.

This system is currently NOT capable of being run in parallel, so a Load
Balancer will not add any benefits.
-->

<p>A single compute engine virtual machine, referred to as the <strong>service machine</strong>
from now on, should be created to host the application server, webserver and
database server. In large productions, these servers can of course be hosted on
different machines if desired.</p>
<p>The web application is built upon Django, a Python framework to develop
data-driven dynamic websites. An <em>nginx</em> server is configured to serve the
static files of the website, as well as proxying Django URLs to the application
server. (<a href="https://www.uvicorn.org">Uvicorn</a> is the chosen application server).
Application data is stored in a file-based SQLite database which can be easily
replaced by a managed SQL service for large production environments.</p>
<p>From the web application, HPC clusters can be created on GCP by administrators.
A typical HPC cluster contains a single Slurm controller node, and one or more
login nodes, typically all running on low- to mid-range virtual machines. The
controller node hosts the Slurm job scheduler. Through the job scheduler,
compute nodes can be started or terminated as required. The controller node and
login nodes all provide public IP addresses for administrators or users to SSH
into, although doing so is not mandatory as day-to-day tasks can be performed
via the web interface.</p>
<p>The Slurm job scheduler supports partitions. Each partition can have compute
nodes of different instance types. All major HPC capable instance types can be
supported from a single cluster if so desired. Of course, it is also possible
to create multiple clusters, which is entirely an
operational decision by the administrators.</p>
<p>For each cluster, two shared filesystems are created to host a system directory
for applications and a home directory for users' job data. Additional
filesystems can be created or imported, to be mounted to the clusters.</p>
<p>For each deployment, a GCS bucket is created to hold supporting files,
including configurations to build the service machine, and Ansible
configurations to set up various Slurm nodes. The same GCS bucket is also
served as a long-term backup to application and job data, including log files
for most cloud operations and selected files created by jobs.</p>
<p>Communication between the service machine and clusters is handled by
<a href="https://cloud.google.com/pubsub">Pub/Sub</a>. For technical details, consult the
<a href="../../../admins/cluster_guide/">Cluster Command &amp; Control</a> document. Alternatively,
there is an API layer around Django to allow incoming communication to the
service machine.</p>
<h2 id="deploy-the-system">Deploy the system</h2>
<p>Please follow the deployment section in the
<a href="../../../admins/admin_guide/">Administrator’s Guide</a> to deploy the system for testing and
development.</p>
<p>Here are some notes from a developer's perspective:</p>
<ul>
<li>The deployment is done using Terraform.</li>
<li>When <code>deploy.sh</code> is invoked, it validates the client machine's development
  environment, collects configuration information from user, save input
  variables in <code>tf/terraform.tfvars</code>, and invoke Terraform.</li>
<li>The deploy script will check the GCP project being used has the correct
    APIs enabled.  The list of required APIs is embedded in <code>deploy.sh</code>
    script - <strong>this will need to be maintained</strong>.</li>
<li>The deploy script will also, optionally, use an additional script,
    <code>script/service_account.sh</code>, to create a GCP service account.  This sets
    the correct roles/permissions on the account based on a list kept in the
    script - <strong>this will need to be maintained</strong>.</li>
<li>Terraform creates a hosting VPC and a subnetwork for the deployment, together
  with the necessary firewall rules.</li>
<li>Terraform creates a supporting GCS bucket. This bucket is not only used
  during deployment, but also provides a long-term storage for clusters
  operating within this deployment.</li>
<li>Terraform sets up a Pub/Sub topic for communication between the service
  machine and clusters.</li>
<li>Terraform provisions a compute engine virtual machine to be the service
  machine. A startup script is then executed on the service machine to set up
  the software environment for HPC Toolkit and Django, and start the web and
  application servers.</li>
</ul>
<h2 id="access-the-service-machine">Access the service machine</h2>
<p>By default, access to the service machine is restricted to authorised users
(the owner/editor of the hosting GCP project or other users delegated with
sufficient permissions). Use one of the following two methods to access the
system after a new deployment:</p>
<ul>
<li>SSH into the service machine directly from the GCP console of the hosting GCP
  project.</li>
<li>Edit the hosting VM instance by uploading the public SSH key of a client
  machine to grant SSH access.</li>
</ul>
<p>Immediately after login, run <code>sudo su -l gcluster</code> to become the <em>gcluster</em>
user. This user account was created during the deployment to be the owner of
the FrontEnd files.</p>
<h2 id="directory-structures-on-service-machine">Directory structures on service machine</h2>
<p>The home directory of the <em>gcluster</em> account is at <code>/opt/gcluster</code>. For a new deployment, the following four sub-directories are created:</p>
<ul>
<li><code>go</code> - the development environment of the Go programming language, required to build Google HPC Toolkit</li>
<li><code>hpc-toolkit</code> - a clone of the Google HPC Toolkit project. The <code>ghpc</code> binary
   should have already been built during the deployment. The <code>frontend</code>
   sub-directory contains the Django-based web application for the FrontEnd and
   other supporting files.</li>
<li><code>django-env</code> - a Python 3 virtual environment containing everything required
   to support Django development. To activate this environment:
   <code>source ~/django-env/bin/activate</code>. Doing so may be required during the
   development, e.g., when running the Django <code>manage.py</code> script for
   administration tasks.</li>
<li><code>run</code> -  directory for run-time data, including the following log files:</li>
<li><code>nginx-access.log</code> - web server access log.</li>
<li><code>nginx-error.log</code> - web server error log.</li>
<li><code>supvisor.log</code> -  Django application server log. Python <code>print</code> from
     Django source files will appear in this file for debugging purposes.</li>
<li><code>django.log</code> - additional debugging information generated by the Python
     logging module is writen here.</li>
</ul>
<h2 id="run-time-data">Run-time data</h2>
<h3 id="for-cloud-resources">For cloud resources</h3>
<p>Run-time data to support creating and managing cloud resources are generated
and stored in the following sub-directories within <code>hpc-toolkit/frontend</code> on
the service machine:</p>
<ul>
<li><code>clusters/cluster_\&lt;id&gt;</code> - holding run-time data for a cluster. <code>\&lt;id&gt;</code> here
has a one-to-one mapping to the IDs shown in the frontend's cluster list page.
The directory contains the following:</li>
<li><code>cluster.yaml</code> - input file for <code>ghpc</code>, generated based on information
    collected from the web interface.</li>
<li><code>\&lt;cluster_name&gt;_\&lt;random_id&gt;/primary</code> - Terraform files generated by
   <code>ghpc</code> to create the cluster, and log files from running
   <code>terraform init/validate/plan/apply</code>. Should there be a need to manually
    clean up the associated cloud resources, run <code>terraform destroy</code> here.</li>
<li><code>vpcs/vpc_\&lt;id&gt;</code> - similar to above but holding run-time data for a virtual
  network. Currently creating custom mode VPC is not yet supported by HPC
  Toolkit. A custom set of Terraform configurations are used.</li>
<li><code>fs/fs_\&lt;id&gt;</code> - similar to above but holding run-time data for a filesystem.
  Currently only GCP Filestore is supported.</li>
</ul>
<p>Note that life cycles of VPCs and Filestores are managed independently to those
of clusters.</p>
<h3 id="for-applications">For applications</h3>
<p>Application data is stored in the shared filesystem <code>/opt/cluster</code>. It contains the following sub-directories:</p>
<ul>
<li><code>/opt/cluster/spack</code> contains a Spack v0.17.1 installation.</li>
<li>When applications are installed via the web interface, supporting files are
  saved in <code>/opt/cluster/install/&lt;application_id&gt;</code> where <code>&lt;application_id&gt;</code> can
  be located from the web interface.</li>
<li>For a Spack installation, a job script <code>install.sh</code> is generated to
    submit a Slurm job to the selected partition to run <code>spack install</code> of
    the desired package.</li>
<li>For a custom installation, a job script <code>install_submit.sh</code> is generated
    to submit a Slurm job to the selected partition to execute <code>job.sh</code> which
    contains the custom installation steps.</li>
<li>After each successful installation, Spack application binaries are stored at
  <code>/opt/cluster/spack/opt/spack/linux-centos7-&lt;arch&gt;</code> where <code>&lt;arch&gt;</code> is the
  architecture of the processors on which the binaries get built, such as
  <code>cascadelake</code> or <code>zen2</code>.</li>
<li>Standard output and error files for Slurm jobs are stored in the working
  directories and also uploaded to the GCS bucket associated with the
  deployment at <code>gs://&lt;deployment_name&gt;-&lt;deployment_zone&gt;-storage/clusters/&lt;cluster_id&gt;/installs/&lt;application_id&gt;/stdout|err</code>
  so that they remain available even if the clusters are destroyed.</li>
</ul>
<h3 id="for-jobs">For jobs</h3>
<p>Job data is stored in the shared filesystem <code>/home/&lt;username&gt;</code> for each user.
Here <code>&lt;username&gt;</code> is the OS Login username, which is generated by Google and
will be different from the user's normal UNIX name. The home directories
contain the following:</p>
<ul>
<li>When a job is submitted from the web interface, supporting files are saved in
  <code>/home/&lt;username&gt;/jobs/&lt;job_id&gt;</code> where <code>&lt;job_id&gt;</code> can be located from the web
  interface.</li>
<li>When running a Spack application, a job script <code>submit.sh</code> is generated to
  submit a Slurm job. This script performs a <code>spack load</code> to set up the
  application environment and then invoke <code>job.sh</code> which contains the
  user-supplied custom commands to run the job.</li>
<li>Standard output and error files for Slurm jobs are uploaded to the GCS bucket
  associated with the deployment at the following URLs:
  <code>gs://&lt;deployment_name&gt;-&lt;deployment_zone&gt;-storage/clusters/&lt;cluster_id&gt;/jobs/&lt;job_id&gt;/stdout|err</code>.</li>
</ul>
<p>Note that a special home directory is created at <code>/home/root_jobs</code> to host jobs
submitted by the Django superusers. For convenience they do not need Google
identities and their jobs are run as <em>root</em> on the clusters.</p>
<h2 id="django-development">Django development</h2>
<h3 id="database-design">Database Design</h3>
<p>Django is great at building data-driven applications. The major system
components, such as clusters, applications, and jobs, can easily map to Django
data models. The database design of this system is best shown with a UML
diagram. This was generated using a function available in the Python
<em>django-extensions</em> package (depending on the Python <em>pydotplus</em> package and
<em>graphviz</em> package to create the image output). To generate the UML diagram,
run from the command line:</p>
<pre><code class="language-python">python manage.py graph_models -a -X &lt;classes_to_exclude&gt; -o UML_output.png
</code></pre>
<p>To simplify the output and exclude Django's internal models, append a list of
comma-separated class names after the -X flag. The result is shown below:</p>
<p><img alt="UML" src="../../images/db-UML.png" /></p>
<p>Note that the <em>CloudResource</em> model is at the base of all cloud resources
including network components, storage components, compute instance
(representing a single VM), clusters, and Workbenches.</p>
<h3 id="code-layout">Code Layout</h3>
<p>The top few layers of the directory hierarchy of the HPC Toolkit FrontEnd
define the major components:</p>
<table>
<thead>
<tr>
<th>dir</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hpc-toolkit/frontend/</code></td>
<td>Top level</td>
</tr>
<tr>
<td><code>.../cli/</code></td>
<td>client commandline interface</td>
</tr>
<tr>
<td><code>.../docs/</code></td>
<td>documentation</td>
</tr>
<tr>
<td><code>.../infrastructure_files/</code></td>
<td>Support files for deploying cloud infrastructure</td>
</tr>
<tr>
<td><code>.../tf/</code></td>
<td>Terraform files for deploying the HPC FrontEnd</td>
</tr>
<tr>
<td><code>.../website/</code></td>
<td>Source code for the HPC Frontend website</td>
</tr>
</tbody>
</table>
<h4 id="infrastructure-files">Infrastructure Files</h4>
<table>
<thead>
<tr>
<th>dir</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.../frontend/infrastructure_files/</code></td>
<td>Top level</td>
</tr>
<tr>
<td><code>.../cluster_startup/</code></td>
<td>Bootstrap startup scripts</td>
</tr>
<tr>
<td><code>.../gcs_bucket/</code></td>
<td>Common configuration files (scripts, Ansible) to store in GCS</td>
</tr>
<tr>
<td><code>.../vpc_tf/</code></td>
<td>Terraform templates for creating VPCs</td>
</tr>
<tr>
<td><code>.../workbench_tf/</code></td>
<td>Terraform templates for creating Workbenches</td>
</tr>
</tbody>
</table>
<p>These directories hold all the support infrastructure files which are used to
create, provision, and initialize the cloud resources which may be created via
the HPC Toolkit FrontEnd.  The VPC Terraform and Workbench Terraform files may
eventually migrate into HPC Toolkit YAML files.</p>
<p>The files under <code>gcs_bucket</code> contain the more in-depth startup scripts and
configuration information for the FrontEnd webserver as well as for new
clusters.  During the initial deployment of the HPC Toolkit FrontEnd, this
directory is copied to a new Google Cloud Storage bucket which is then used for
storing these startup codes as well as additional cluster information, such as
log files.  When clusters are created in Google Cloud, the initial bootstrap
template startup script (from the <code>cluster_startup</code> directory) are set to be
the instance startup script.  These scripts are responsible for downloading
from Google Cloud Storage the Ansible repository which is stored in the
<code>gcs_bucket/clusters/ansible_setup/</code>, and running Ansible to initialize the
instance.</p>
<p>The source-code for the cluster client-side Command &amp; Control daemon is stored
here as well, under
<code>.../ansible_setup/roles/c2_daemon/files/ghpcfe_c2daemon.py</code></p>
<h4 id="website">Website</h4>
<table>
<thead>
<tr>
<th>dir</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.../frontend/website/</code></td>
<td>Top level</td>
</tr>
<tr>
<td><code>.../ghpcfe/</code></td>
<td>Frontend Application dir</td>
</tr>
<tr>
<td><code>....../cluster_manager/</code></td>
<td>Utilities for cloud &amp; backend operations</td>
</tr>
<tr>
<td><code>....../management/</code></td>
<td>Extra Django setup commands</td>
</tr>
<tr>
<td><code>....../migrations/</code></td>
<td>Database migration scripts</td>
</tr>
<tr>
<td><code>....../static/</code></td>
<td>Images, Javascript and other static web collateral</td>
</tr>
<tr>
<td><code>....../templates/</code></td>
<td>Web view templates</td>
</tr>
<tr>
<td><code>....../views/</code></td>
<td>Python files for model views</td>
</tr>
<tr>
<td><code>.../templates/</code></td>
<td>All-Social plugin Templates</td>
</tr>
<tr>
<td><code>.../website/</code></td>
<td>Django core website configuration (including <code>settings.py</code>)</td>
</tr>
<tr>
<td><code>.../manage.py</code></td>
<td>Core Django application management script</td>
</tr>
</tbody>
</table>
<p>As with many Django-based web applications, the HPC Toolkit FrontEnd Django
application is broken across multiple directories, each responsible for some
critical subcomponent of the overall application, implementing the MVT (model,
view, template) architecture.  The <code>ghpcfe/</code> directory hosts the pieces
specific to the HPC Toolkit FrontEnd, whereas the other directories are more
Django-focused.</p>
<p>Under <code>ghpcfe/</code>, there are a variety of directories as show in the above
table.  Directly inside this directory is the majority of the Python files
which make up the Frontend web application. Of particular interest would be
<code>models.py</code>, which stores the DB models and <code>forms.py</code>, for custom web forms.
There are a sufficiently large number of Django views in the application, so
the prototypical <code>views.py</code> is broken into its own Python package.</p>
<p>Also under <code>ghpcfe/</code> is the <code>cluster_manager</code> directory, which contains most of
the "backend" code responsible for gathering cloud information as well as
creating, controlling, and configuring cloud resources.  Of particular interest
here are the files:</p>
<ul>
<li><code>c2.py</code>: Responsible for bidirectional communication between the FrontEnd and
  any created clusters.</li>
<li><code>cloud_info.py</code>: Provides many utilities for querying information from Google
  Cloud about instance types, pricing, VPCs and so forth</li>
<li><code>cluster_info.py</code>: Responsible for creating clusters and keeping track of
  local-to-frontend cluster metadata</li>
</ul>
<p>Note that these "backend" functions are often invoked asynchronously if the
tasks performed are time-consuming. Support to asynchronous views were
introduced in Django v3.1.</p>
<p>Finally, <code>templates</code> directory contains the web view templates. Django ships
with its own template engine to process these template files and insert dynamic
contents to them.</p>
<h2 id="workbenches-architecture">Workbenches Architecture</h2>
<p>The workbench process is fairly straight-forward. Gather configuration values
from the FrontEnd and pass them to Terraform to control the creation of the
workbench instance. This is done directly via Terraform as the HPC Toolkit does
not currently support Vertex AI Workbenches.</p>
<h3 id="infrastructure-files_1">Infrastructure files</h3>
<p>Workbenches are created using a template configuration in
<code>hpc-toolkit/frontend/infrastructure_files/workbench_tf</code>. The Terraform
template was originally based on the Terraform template provided by the
<a href="https://github.com/GoogleCloudPlatform/rad-lab">Google Cloud Platform Rad-Lab git repo</a>
however the configuration diverged during early development. The main reason
for this divergence was to accommodate running the Jupyter notebook as a
specific OSLogin user rather than the generic Jupyter user which would make it
impossible to interact properly with any mounted shared storage.</p>
<p>The process of creating the workbench files is mostly contained within the file
<code>hpc-toolkit/frontend/website/ghpcfe/cluster_manager/workbenchinfo.py</code>. The
<code>copy_terraform()</code> routine copies files from the <code>infrastructure_files</code>
directory while the <code>prepare_terraform_vars()</code> routine creates a
<code>terraform.tfvars</code> file within the
<code>hpc-toolkit/frontend/workbenches/workbench_##</code> directory to provide the
following info gathered by the FrontEnd during the workbench creation process:</p>
<ul>
<li>region</li>
<li>zone</li>
<li>project_name</li>
<li>subnet_name</li>
<li>machine_type</li>
<li>boot_disk_type</li>
<li>boot_disk_size_gb</li>
<li>trusted_users</li>
<li>image_family</li>
<li>owner_id</li>
<li>wb_startup_script_name</li>
<li>wb_startup_script_bucket</li>
</ul>
<h3 id="storage-mount-points">Storage mount points</h3>
<p>Storage mount points are configured on the second part of the creation process.
This is done via a Django UpdateView form at
<code>https://$FRONTEND.URL/workbench/update/##</code> with the main configuration fields
disabled as Terraform does not support modification of an existing Vertex AI
workbench, the workbench would be destroyed and recreated.</p>
<p>Additionally the mount points are added to the startup script and there is no
method in the frontend to re-run this startup script to mount any additional
mount points therefore the UpdateView form is only presented during the
creation process. Once information on the mount points is collected the startup
script can be generated.</p>
<h3 id="startup-script">Startup script</h3>
<p>The startup script is generated by the <code>copy_startup_script()</code> process in
<code>cluster_manager/workbenchinfo.py</code>. This process has two parts. The first part
is generated using information gathered by the frontend and passes the user's
social ID number set by the owner_id field. It also passes any configured mount
points into the startup script before the second part of the startup script is
copied from <code>infrastructure_files/gcs_bucket/workbench/startup_script_template.sh</code>.</p>
<p>The startup script runs the following processes when the workbench instance
boots:</p>
<ul>
<li>Query instance metadata for list of users and filter based on the users
  social ID number to discover the correct format of their OSLogin username.</li>
<li>Install nfs-common package via <code>apt-get</code>.</li>
<li>Make temporary jupyterhome directory in /tmp/ and set user ownership.</li>
<li>Make home directory for the user and set user ownership.</li>
<li>Copy Jupyter configuration files from <code>/home/jupyter/.jupyter</code> to
  <code>/tmp/jupyterhome/.jupyter</code>.</li>
<li>Create <code>DATA_LOSS_WARNING.txt</code> file with warning message.</li>
<li>Configure specified mount points in order specified on FrontEnd.</li>
<li>Add symlink to <code>/tmp/jupyterhome/</code> which will serve as working directory on
  the web interface.</li>
<li>This process of mounting and symlinking means the mountpoint will appear
    in both the jupyter notebook web interface working directory and in the
    expected location in the root filesystem.</li>
<li>Append mount points to <code>DATA_LOSS_WARNING.txt</code> file.</li>
<li>If <code>/home</code> was not mounted as a mount point then create a symlink to
  <code>/home</code> in <code>/tmp/jupyterhome</code>.</li>
<li>Modify Jupyter config to reflect username and new working directory.</li>
<li>Update <code>/lib/systemd/system/jupyter.service</code> systemd service file to reflect
  username and new working directory.</li>
<li>Run <code>systemctl</code> daemon-reload and restart Jupyter service.</li>
<li>Without updating the Jupyter config and restarting the service then the
    Jupyter notebook would be running as the jupyter user. This would break
    permissions used on any mounted shared storage.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.sections", "navigation.top", "navigation.tracking", "navigation.path", "search.suggest", "search.highlight", "toc.follow"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a7c05c9e.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.3/lottie.min.js"></script>
      
        <script src="../../javascripts/extra.js"></script>
      
    
  </body>
</html>